<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraOS Desktop Simulation v2.0</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ macOS */
        :root {
            /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¢–µ–º–Ω–æ–π –¢–µ–º—ã */
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --text-primary: #e6edf3;
            --text-secondary: #909ba8;
            --window-bg: rgba(22, 27, 34, 0.9);
            --frosted-bg: rgba(255, 255, 255, 0.1);
            --border-color: rgba(255, 255, 255, 0.1);
        }

        /* –°–≤–µ—Ç–ª–∞—è –¢–µ–º–∞ (–î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ <body> –ø—Ä–∏ data-theme="light") */
        body[data-theme="light"] {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --window-bg: rgba(255, 255, 255, 0.9);
            --frosted-bg: rgba(0, 0, 0, 0.05);
            --border-color: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            overflow: hidden;
            transition: background-color 0.3s;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –ú–∞—Ç–æ–≤–æ–≥–æ –°—Ç–µ–∫–ª–∞ (Frosted Glass) */
        .frosted-glass {
            background-color: var(--frosted-bg);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–∏–ª—å –æ–∫–Ω–∞ */
        .window {
            background-color: var(--window-bg);
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–µ–Ω—å –¥–ª—è –æ–∫–æ–Ω –∏ –¥–æ–∫–∞ */
        .shadow-macos {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –ª–æ–≥–æ—Ç–∏–ø–∞ */
        @keyframes pulse-logo {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        .pulse-animation {
            animation: pulse-logo 2s infinite ease-in-out;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –≤ –î–æ–∫–µ */
        .dock-icon {
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .dock-icon:hover {
            transform: scale(1.3) translateY(-8px);
            z-index: 1000;
            filter: brightness(1.2);
        }

        /* –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–∫–Ω–æ–º */
        .window-control {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            opacity: 0.8;
            transition: opacity 0.15s;
        }
        .window-control:hover {
            opacity: 1;
        }
        .window-control-close { background-color: #ff5f56; } /* –ö—Ä–∞—Å–Ω—ã–π */
        .window-control-minimize { background-color: #ffbd2e; } /* –ñ–µ–ª—Ç—ã–π */
        .window-control-maximize { background-color: #27c93f; } /* –ó–µ–ª–µ–Ω—ã–π */

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ (—Ö—ç–Ω–¥–ª–µ—Ä) */
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            bottom: 0;
            right: 0;
            cursor: nwse-resize;
            z-index: 10;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –¢–µ—Ä–º–∏–Ω–∞–ª–∞ */
        .terminal-content {
            font-family: monospace;
            background-color: black;
            color: #27c93f;
            padding: 10px;
            height: 100%;
            overflow-y: auto;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ */
        .fade-out {
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è Desktop: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—è–º–∏ */
        #desktop {
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease;
        }
    </style>
</head>
<body class="w-screen h-screen relative select-none">

    <!-- 3. –°—Ç–∞—Ä—Ç–æ–≤—ã–π –≠–∫—Ä–∞–Ω (Loading Screen) -->
    <div id="loading-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black transition-opacity duration-500">
        <!-- –õ–æ–≥–æ—Ç–∏–ø AuraOS (—Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è 'A' –∫–∞–∫ SVG) -->
        <svg id="aura-logo" class="w-24 h-24 text-white pulse-animation" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L2 22H6L10.5 13H13.5L18 22H22L12 2ZM12 4.4L15.3 11H8.7L12 4.4Z" />
        </svg>
        <p class="text-white text-sm mt-4 tracking-wider">AuraOS</p>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ü—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
        <div class="w-48 h-1 bg-gray-700 rounded-full mt-12 overflow-hidden">
            <div id="progress-bar" class="h-full bg-white transition-all duration-700 ease-linear" style="width: 0%;"></div>
        </div>
    </div>

    <!-- –†–∞–±–æ—á–∏–π –°—Ç–æ–ª (Desktop) -->
    <div id="desktop" class="w-full h-full relative">
        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç —Ä–∞—Å–ø–æ–ª–∞–≥–∞—Ç—å—Å—è –æ–∫–Ω–∞ -->

        <!-- 4. –î–æ–∫ (Dock) -->
        <div id="dock" class="fixed bottom-3 left-1/2 -translate-x-1/2 p-2 flex space-x-4 rounded-3xl shadow-macos z-50 frosted-glass">
            <!-- –ò–∫–æ–Ω–∫–∞ 1: Finder -->
            <div id="app-finder" data-app="Finder" title="Finder" class="dock-icon p-2 rounded-xl text-white bg-blue-500 cursor-pointer w-12 h-12 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            </div>
            <!-- –ò–∫–æ–Ω–∫–∞ 2: Browser -->
            <div id="app-browser" data-app="Browser" title="Browser" class="dock-icon p-2 rounded-xl text-white bg-red-500 cursor-pointer w-12 h-12 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.418 0-8-3.582-8-8s3.582-8 8-8 8 3.582 8 8-3.582 8-8 8zm-.5-5h1c.276 0 .5-.224.5-.5s-.224-.5-.5-.5h-1c-.276 0-.5.224-.5.5s.224.5.5.5zM12 6c-2.761 0-5 2.239-5 5s2.239 5 5 5 5-2.239 5-5-2.239-5-5-5zm0 8c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z"/></svg>
            </div>
            <!-- –ò–∫–æ–Ω–∫–∞ 3: Terminal -->
            <div id="app-terminal" data-app="Terminal" title="Terminal" class="dock-icon p-2 rounded-xl text-white bg-gray-900 cursor-pointer w-12 h-12 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 17l6-6-6-6M12 19h8"/></svg>
            </div>
            <!-- –ò–∫–æ–Ω–∫–∞ 4: Aura AI (–ù–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ) -->
            <div id="app-aura-ai" data-app="AuraAI" title="Aura AI Assistant" class="dock-icon p-2 rounded-xl text-white bg-purple-600 cursor-pointer w-12 h-12 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-1 15h2v2h-2zm0-8h2v6h-2z"/></svg>
            </div>
            <!-- –ò–∫–æ–Ω–∫–∞ 5: Settings -->
            <div id="app-settings" data-app="Settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" class="dock-icon p-2 rounded-xl text-white bg-gray-500 cursor-pointer w-12 h-12 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-.98-.75-1.46-1.07l-.37-2.61c-.02-.24-.22-.42-.46-.42h-4c-.24 0-.44.18-.46.42l-.37 2.61c-.48.32-.94.67-1.46 1.07l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.12.22-.07.49.12.64l2.11 1.65c-.04.32-.07.64-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4.98.75 1.46 1.07l.37 2.61c.02.24.22.42.46.42h4c.24 0 .44-.18.46-.42l.37-2.61c.48-.32.94-.67 1.46-1.07l2.49 1c.22.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/></svg>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –û–∫–Ω–æ –°–æ–æ–±—â–µ–Ω–∏—è (–¥–ª—è –∑–∞–º–µ–Ω—ã alert/confirm) -->
    <div id="message-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black bg-opacity-50">
        <div class="bg-gray-800/90 p-6 rounded-xl shadow-macos w-80 text-white" style="background-color: var(--window-bg);">
            <h3 id="modal-title" class="text-lg font-bold mb-3" style="color: var(--text-primary);">–°–æ–æ–±—â–µ–Ω–∏–µ AuraOS</h3>
            <p id="modal-text" class="mb-6 text-sm" style="color: var(--text-secondary);"></p>
            <button id="modal-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg w-full transition duration-150">–û–ö</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï FIREBASE –ò API ===
        setLogLevel('debug');

        const apiKey = "AIzaSyAC3F8vMt2Yu-LmI_zm9XFDLHLvjUAU0_w"; // –í–∞—à –∫–ª—é—á –¥–ª—è Gemini API
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        let db, auth;
        let isAuthReady = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)
        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        console.log("User authenticated:", user.uid);
                    } else {
                        console.log("No user signed in.");
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    signInWithCustomToken(auth, __initial_auth_token)
                        .then(() => console.log("Signed in with custom token."))
                        .catch(error => {
                            console.error("Custom token sign-in failed. Falling back to anonymous:", error);
                            signInAnonymously(auth);
                        });
                } else {
                    signInAnonymously(auth)
                        .then(() => console.log("Signed in anonymously."))
                        .catch(error => console.error("Anonymous sign-in failed:", error));
                }
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        } else {
            console.warn("Firebase config not found. Running in standalone desktop simulation mode.");
            isAuthReady = true;
        }
        // =======================================================


        // === –ù–ê–°–¢–†–û–ô–ö–ò –°–ò–°–¢–ï–ú–´ –ò –ü–†–ê–ö–¢–ò–ß–ù–û–°–¢–¨ ===
        
        const WALLPAPERS = {
            'dark-nebula': 'https://placehold.co/1920x1080/0d1117/FFFFFF/svg?text=Dark+Nebula',
            'light-abstract': 'https://placehold.co/1920x1080/FFFFFF/333333/svg?text=Light+Wave',
            'gradient-blue': 'https://placehold.co/1920x1080/007AFF/FFFFFF/svg?text=Blue+Gradient',
        };

        const DEFAULT_SETTINGS = {
            theme: 'dark',
            wallpaper: 'dark-nebula'
        };

        function getSettings() {
            try {
                const saved = localStorage.getItem('auraos_settings');
                return saved ? { ...DEFAULT_SETTINGS, ...JSON.parse(saved) } : DEFAULT_SETTINGS;
            } catch (e) {
                console.error("Error loading settings, using default.", e);
                return DEFAULT_SETTINGS;
            }
        }

        function saveSettings(newSettings) {
            try {
                localStorage.setItem('auraos_settings', JSON.stringify(newSettings));
                applySettings(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            } catch (e) {
                console.error("Error saving settings.", e);
            }
        }

        function applySettings() {
            const settings = getSettings();
            const body = document.body;
            const desktop = document.getElementById('desktop');

            // 1. –¢–µ–º–∞
            body.setAttribute('data-theme', settings.theme);

            // 2. –û–±–æ–∏
            const wallpaperUrl = WALLPAPERS[settings.wallpaper] || WALLPAPERS['dark-nebula'];
            desktop.style.backgroundImage = `url('${wallpaperUrl}')`;
        }
        
        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ù–∞—Å—Ç—Ä–æ–µ–∫ ---

        window.handleThemeChange = function(theme) {
            const currentSettings = getSettings();
            saveSettings({ ...currentSettings, theme: theme });
        }

        window.handleWallpaperChange = function(wallpaperKey) {
            if (WALLPAPERS[wallpaperKey]) {
                const currentSettings = getSettings();
                saveSettings({ ...currentSettings, wallpaper: wallpaperKey });
            } else {
                showMessage('–û—à–∏–±–∫–∞ –ù–∞—Å—Ç—Ä–æ–µ–∫', `–û–±–æ–∏ "${wallpaperKey}" –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.`);
            }
        }


        // === –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê AuraOS ===

        const desktop = document.getElementById('desktop');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        let zIndexCounter = 10;
        
        // –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –¥–ª—è Aura AI
        window.auraAIChatHistory = [];

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (–∑–∞–º–µ–Ω–∞ alert())
        function showMessage(title, text) {
            modalTitle.textContent = title;
            modalText.textContent = text;
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
            modalOkBtn.onclick = () => {
                messageModal.classList.add('hidden');
                messageModal.classList.remove('flex');
            };
        }

        // --- 3. –õ–æ–≥–∏–∫–∞ –ó–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ –≠–∫—Ä–∞–Ω–∞ ---
        function startLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            const progressBar = document.getElementById('progress-bar');
            let progress = 0;
            const duration = 3000;
            const intervalTime = 50;
            const steps = duration / intervalTime;
            const increment = 100 / steps;

            const interval = setInterval(() => {
                progress += increment;
                progressBar.style.width = Math.min(progress, 100) + '%';

                if (progress >= 100) {
                    clearInterval(interval);
                    loadingScreen.classList.add('fade-out');
                    setTimeout(() => {
                        loadingScreen.remove();
                        createWindow('Finder', '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ', 300, 200, 400, 250);
                    }, 500);
                }
            }, intervalTime);
        }

        // --- 5. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –û–∫–æ–Ω: –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∏ Z-Index ---
        function makeWindowDraggableAndFocusable(windowEl) {
            const header = windowEl.querySelector('.window-header');
            let isDragging = false;
            let currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

            // Z-Index (–§–æ–∫—É—Å)
            windowEl.addEventListener('mousedown', () => {
                zIndexCounter++;
                windowEl.style.zIndex = zIndexCounter;
            });

            // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
            header.addEventListener('mousedown', dragStart);

            function dragStart(e) {
                if (windowEl.classList.contains('maximized')) return;
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target.closest('.window-controls')) return;

                isDragging = true;
                header.style.cursor = 'grabbing';
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', dragEnd);
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    windowEl.style.transform = "translate3d(" + currentX + "px, " + currentY + "px, 0)";
                }
            }

            function dragEnd(e) {
                isDragging = false;
                header.style.cursor = 'grab';
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', dragEnd);
            }
        }

        // --- 5. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –û–∫–æ–Ω: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –†–∞–∑–º–µ—Ä–∞ ---
        function makeWindowResizable(windowEl) {
            const handle = windowEl.querySelector('.resize-handle');
            let isResizing = false;
            let startX, startY, initialWidth, initialHeight;

            handle.addEventListener('mousedown', resizeStart);

            function resizeStart(e) {
                if (windowEl.classList.contains('maximized')) return;
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                initialWidth = windowEl.offsetWidth;
                initialHeight = windowEl.offsetHeight;

                windowEl.style.transition = 'none';

                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', resizeEnd);
            }

            function resize(e) {
                if (isResizing) {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;

                    let newWidth = initialWidth + deltaX;
                    let newHeight = initialHeight + deltaY;

                    newWidth = Math.max(300, newWidth);
                    newHeight = Math.max(200, newHeight);

                    windowEl.style.width = newWidth + 'px';
                    windowEl.style.height = newHeight + 'px';
                }
            }

            function resizeEnd() {
                isResizing = false;
                windowEl.style.transition = 'width 0.3s, height 0.3s, transform 0.3s';
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', resizeEnd);
            }
        }

        // --- 4 & 5. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –û–∫–Ω–æ–º ---

        function getWindowContent(appId, appTitle) {
            const currentSettings = getSettings();
            const textPrimary = 'var(--text-primary)';
            const textSecondary = 'var(--text-secondary)';
            const windowBg = 'var(--window-bg)';
            
            switch (appId) {
                case 'Finder':
                case '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ':
                    return `
                        <div class="p-4 flex flex-col h-full" style="color: ${textPrimary};">
                            <h2 class="text-xl font-bold mb-3">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AuraOS v2.0!</h2>
                            <p class="mb-4" style="color: ${textSecondary};">
                                –ú—ã –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏–ª–∏ —Å–∏—Å—Ç–µ–º—É! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –º–µ–Ω—è—Ç—å —Ç–µ–º—É –∏ –æ–±–æ–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ 
                                <span class="font-semibold text-blue-500 cursor-pointer" onclick="createWindow('Settings', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', 500, 650)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>.
                            </p>
                            <p class="text-sm text-blue-400">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:</p>
                            <ul class="list-disc list-inside ml-2 text-sm" style="color: ${textSecondary};">
                                <li>–û—Ç–∫—Ä—ã—Ç—å "Aura AI" –∏ —Å–ø—Ä–æ—Å–∏—Ç—å –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–æ–≤–æ—Å—Ç—è—Ö (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Gemini + Google Search).</li>
                                <li>–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–º—É –Ω–∞ —Å–≤–µ—Ç–ª—É—é —á–µ—Ä–µ–∑ –ù–∞—Å—Ç—Ä–æ–π–∫–∏.</li>
                                <li>–ü–æ–º–µ–Ω—è—Ç—å –æ–±–æ–∏ –Ω–∞ —Å–∏–Ω–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç.</li>
                            </ul>
                        </div>
                    `;
                case 'Browser':
                    return `
                        <div class="p-4" style="color: ${textPrimary};">
                            <div class="flex space-x-2 mb-4 p-1 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                                <span class="text-blue-400">‚Üê</span>
                                <span class="text-gray-400">‚Üí</span>
                                <input type="text" value="https://auraos.dev" readonly class="flex-grow rounded px-2 py-1 text-sm focus:outline-none border-none" style="background-color: transparent; color: ${textPrimary};">
                            </div>
                            <div class="h-full text-center py-10">
                                <p class="text-2xl text-red-500">üåê Web-–ë—Ä–∞—É–∑–µ—Ä (AuraBrowser)</p>
                                <p class="text-sm mt-2" style="color: ${textSecondary};">–ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –≠—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å —Å–∏–º—É–ª—è—Ü–∏—è!</p>
                            </div>
                        </div>
                    `;
                case 'Terminal':
                    return `
                        <div class="terminal-content">
                            AuraOS Terminal [–í–µ—Ä—Å–∏—è 1.1.0]<br>
                            (c) 2025 Aura Development. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.<br><br>
                            <span id="terminal-output"></span>
                            <span id="terminal-prompt" class="flex"><span class="text-pink-400">user@AuraOS</span>:<span class="text-blue-400">~</span>$ <input type="text" id="terminal-input" class="bg-transparent border-none text-green-400 flex-grow focus:outline-none caret-white" autofocus onkeydown="if(event.key==='Enter') window.handleTerminalInput(this)"></span>
                        </div>
                    `;
                case 'AuraAI':
                    return `
                        <div class="flex flex-col h-full" style="background-color: var(--bg-secondary);">
                            <div id="aura-ai-chat-output" class="flex-grow overflow-y-auto p-4 space-y-4">
                                <div class="flex justify-start">
                                    <div class="bg-purple-600/80 rounded-xl rounded-tl-sm p-3 text-white max-w-xs shadow-md">
                                        –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø Aura AI, –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫. –°–ø—Ä–æ—Å–∏—Ç–µ –º–µ–Ω—è –æ —á–µ–º —É–≥–æ–¥–Ω–æ!
                                    </div>
                                </div>
                            </div>
                            <div class="p-3 border-t" style="border-color: var(--border-color); background-color: var(--window-bg);">
                                <div class="flex space-x-2">
                                    <input type="text" id="aura-ai-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å —É Aura AI..." class="flex-grow rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 border border-transparent transition" style="background-color: var(--bg-primary); color: ${textPrimary};">
                                    <button id="aura-ai-send-btn" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-lg flex items-center justify-center transition" onclick="window.handleAuraAIChat(document.getElementById('aura-ai-input'))">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                case 'Settings':
                    const themeOptions = [
                        { key: 'dark', label: '–¢–µ–º–Ω–∞—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)' },
                        { key: 'light', label: '–°–≤–µ—Ç–ª–∞—è (–∫–ª–∞—Å—Å–∏–∫–∞)' }
                    ];

                    const wallpaperOptions = Object.keys(WALLPAPERS).map(key => ({
                        key: key,
                        label: key.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')
                    }));

                    return `
                        <div class="p-4 space-y-6 overflow-y-auto h-full" style="color: ${textPrimary};">
                            <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="border-color: var(--border-color);">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –°–∏—Å—Ç–µ–º—ã</h2>

                            <!-- –°–µ–∫—Ü–∏—è –í–Ω–µ—à–Ω–∏–π –í–∏–¥ -->
                            <div>
                                <h3 class="text-lg font-semibold mb-3">–í–Ω–µ—à–Ω–∏–π –í–∏–¥ (Appearance)</h3>
                                
                                <div class="p-4 rounded-xl border" style="border-color: var(--border-color); background-color: var(--bg-secondary);">
                                    <p class="font-medium mb-2 text-sm" style="color: ${textSecondary};">–¢–µ–º–∞:</p>
                                    <div class="flex space-x-4">
                                        ${themeOptions.map(option => `
                                            <button 
                                                class="px-4 py-2 rounded-lg font-medium text-sm transition-all duration-200 ${currentSettings.theme === option.key ? 'bg-blue-600 text-white' : 'bg-gray-500/20 hover:bg-gray-500/30'}"
                                                onclick="window.handleThemeChange('${option.key}')"
                                            >
                                                ${option.label}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>

                            <!-- –°–µ–∫—Ü–∏—è –û–±–æ–∏ -->
                            <div>
                                <h3 class="text-lg font-semibold mb-3">–û–±–æ–∏ (Desktop Background)</h3>
                                
                                <div class="grid grid-cols-2 gap-4 p-4 rounded-xl border" style="border-color: var(--border-color); background-color: var(--bg-secondary);">
                                    ${wallpaperOptions.map(option => `
                                        <div 
                                            class="p-2 border-2 rounded-lg cursor-pointer transition-all duration-200"
                                            style="
                                                border-color: ${currentSettings.wallpaper === option.key ? '#3b82f6' : 'var(--border-color)'};
                                                background-image: url('${WALLPAPERS[option.key]}');
                                                background-size: cover; 
                                                height: 100px;
                                            "
                                            onclick="window.handleWallpaperChange('${option.key}')"
                                        >
                                            <div class="text-xs font-medium backdrop-blur-sm bg-black/30 p-1 rounded" style="color: white;">${option.label}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- –°–µ–∫—Ü–∏—è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                            <div class="pt-4 border-t" style="border-color: var(--border-color);">
                                <h3 class="text-lg font-semibold mb-3">–°–∏—Å—Ç–µ–º–∞</h3>
                                <p class="text-sm" style="color: ${textSecondary};">–í–µ—Ä—Å–∏—è: AuraOS v2.0</p>
                                <p class="text-sm" style="color: ${textSecondary};">Powered by: Gemini AI</p>
                                <p class="text-sm mt-1 text-blue-500 cursor-pointer" onclick="showMessage('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', 'AuraOS v2.0: —Å–∏–º—É–ª—è—Ü–∏—è —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏.')">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...</p>
                            </div>
                        </div>
                    `;
                default:
                    return `<div class="p-4" style="color: ${textPrimary};">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: ${appTitle}</div>`;
            }
        }

        function createWindow(appId, title, width, height, x, y) {
            const windowEl = document.createElement('div');
            const content = getWindowContent(appId, title);
            const initialX = x || Math.floor(Math.random() * (desktop.offsetWidth - width - 100)) + 50;
            const initialY = y || Math.floor(Math.random() * (desktop.offsetHeight - height - 100)) + 50;

            zIndexCounter++;

            // –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –∫–ª–∞—Å—Å—ã —Ü–≤–µ—Ç–∞ (bg-gray-800/80) —É–¥–∞–ª–µ–Ω—ã,
            // —á—Ç–æ–±—ã —Å—Ç–∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª—è–ª–∏—Å—å —á–µ—Ä–µ–∑ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            windowEl.className = `window absolute rounded-xl shadow-macos flex flex-col overflow-hidden transition-all duration-300 ease-out`;
            windowEl.style.width = `${width}px`;
            windowEl.style.height = `${height}px`;
            windowEl.style.transform = `translate3d(${initialX}px, ${initialY}px, 0)`;
            windowEl.style.zIndex = zIndexCounter;
            windowEl.dataset.appId = appId;

            windowEl.innerHTML = `
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –û–∫–Ω–∞ (Frosted Glass) -->
                <div class="window-header flex items-center p-3 h-8 frosted-glass cursor-grab flex-shrink-0">
                    <!-- –ö–Ω–æ–ø–∫–∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                    <div class="window-controls flex items-center">
                        <div class="window-control window-control-close" title="–ó–∞–∫—Ä—ã—Ç—å"></div>
                        <div class="window-control window-control-minimize" title="–°–≤–µ—Ä–Ω—É—Ç—å"></div>
                        <div class="window-control window-control-maximize" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å/–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"></div>
                    </div>
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                    <span class="text-xs font-semibold ml-4 truncate flex-grow text-center" style="color: var(--text-primary);">
                        ${title}
                    </span>
                </div>

                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –û–∫–Ω–∞ -->
                <div class="window-content flex-grow relative p-0 overflow-hidden">
                    ${content}
                </div>

                <!-- –•—ç–Ω–¥–ª–µ—Ä –ò–∑–º–µ–Ω–µ–Ω–∏—è –†–∞–∑–º–µ—Ä–∞ (Bottom-Right) -->
                <div class="resize-handle"></div>
            `;

            desktop.appendChild(windowEl);

            makeWindowDraggableAndFocusable(windowEl);
            makeWindowResizable(windowEl);

            // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const closeBtn = windowEl.querySelector('.window-control-close');
            const maximizeBtn = windowEl.querySelector('.window-control-maximize');

            // –ö—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞: –ó–∞–∫—Ä—ã—Ç—å
            closeBtn.onclick = () => {
                windowEl.remove();
            };

            // –ó–µ–ª–µ–Ω–∞—è –∫–Ω–æ–ø–∫–∞: –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å/–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            maximizeBtn.onclick = () => {
                const isMaximized = windowEl.classList.contains('maximized');
                
                if (isMaximized) {
                    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (Restore)
                    windowEl.classList.remove('maximized');
                    windowEl.style.width = windowEl.dataset.prevWidth || `${width}px`;
                    windowEl.style.height = windowEl.dataset.prevHeight || `${height}px`;
                    windowEl.style.transform = windowEl.dataset.prevTransform || `translate3d(${initialX}px, ${initialY}px, 0)`;
                } else {
                    // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å (Maximize)
                    windowEl.dataset.prevWidth = windowEl.style.width;
                    windowEl.dataset.prevHeight = windowEl.style.height;
                    windowEl.dataset.prevTransform = windowEl.style.transform;

                    windowEl.classList.add('maximized');
                    windowEl.style.width = '100%';
                    windowEl.style.height = 'calc(100% - 68px)';
                    windowEl.style.transform = 'translate3d(0, 0, 0)';
                }
            };

            if (appId === 'Terminal') {
                initializeTerminal(windowEl);
            }
        }

        // --- 6. –ö–æ–Ω—Ç–µ–Ω—Ç: –õ–æ–≥–∏–∫–∞ –¢–µ—Ä–º–∏–Ω–∞–ª–∞ ---
        function initializeTerminal(windowEl) {
            const terminalOutput = windowEl.querySelector('#terminal-output');
            const terminalInput = windowEl.querySelector('#terminal-input');

            const commands = {
                'help': '–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: help, echo [—Ç–µ–∫—Å—Ç], clear, about, time',
                'about': 'AuraOS v2.0. –°–∏–º—É–ª—è—Ü–∏—è —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞ —Å Gemini AI –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Ç–µ–º—ã.',
                'time': new Date().toLocaleString('ru-RU'),
                'clear': 'clear',
                'echo': (args) => args.join(' ')
            };

            window.handleTerminalInput = function(inputEl) {
                const commandLine = inputEl.value.trim();
                const content = windowEl.querySelector('.terminal-content');

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã
                terminalOutput.innerHTML += `<span class="text-pink-400">user@AuraOS</span>:<span class="text-blue-400">~</span>$ <span class="text-green-400">${commandLine}</span><br>`;

                const [cmd, ...args] = commandLine.toLowerCase().split(' ');
                let result = '';

                if (cmd === 'clear') {
                    terminalOutput.innerHTML = '';
                } else if (commands[cmd]) {
                    if (typeof commands[cmd] === 'function') {
                        result = commands[cmd](args);
                    } else {
                        result = commands[cmd];
                    }
                    if (result !== 'clear') {
                         terminalOutput.innerHTML += result + '<br>';
                    }
                } else {
                    result = `–û—à–∏–±–∫–∞: –ö–æ–º–∞–Ω–¥–∞ "${cmd}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ 'help'.`;
                    terminalOutput.innerHTML += result + '<br>';
                }

                inputEl.value = '';
                // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
                content.scrollTop = content.scrollHeight;
            }
            window.handleTerminalInput = window.handleTerminalInput.bind(null); // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        }
        
        // --- 7. –ö–æ–Ω—Ç–µ–Ω—Ç: –õ–æ–≥–∏–∫–∞ Aura AI (Gemini API) ---

        /**
         * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–∫–Ω–µ —á–∞—Ç–∞.
         */
        function displayMessage(role, text) {
            const chatOutput = document.getElementById('aura-ai-chat-output');
            if (!chatOutput) return;

            const isUser = role === 'user';
            const bgColor = isUser ? 'bg-blue-600/80' : 'bg-purple-600/80';
            const alignment = isUser ? 'justify-end' : 'justify-start';
            const roundedClass = isUser ? 'rounded-br-sm' : 'rounded-tl-sm';

            const messageHtml = `
                <div class="flex ${alignment}">
                    <div class="${bgColor} rounded-xl ${roundedClass} p-3 text-white max-w-xs shadow-md whitespace-pre-wrap">
                        ${text}
                    </div>
                </div>
            `;
            chatOutput.innerHTML += messageHtml;
            chatOutput.scrollTop = chatOutput.scrollHeight;
        }

        /**
         * –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤—ã–∑–æ–≤ Gemini API —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π.
         */
        async function fetchGeminiResponse(contents, attempt = 0) {
            const maxRetries = 3;

            try {
                const payload = {
                    contents: contents,
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: "You are Aura AI, a helpful, friendly, and concise desktop assistant running in a simulated operating system. Respond briefly and engagingly in Russian." }]
                    },
                };

                const response = await fetch(geminiApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç.";
                return text;

            } catch (error) {
                if (attempt < maxRetries) {
                    const delay = Math.pow(2, attempt) * 1000;
                    // console.warn(`Retrying API call in ${delay}ms...`, error.message);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchGeminiResponse(contents, attempt + 1);
                } else {
                    throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Aura AI: ${error.message}`);
                }
            }
        }
        
        window.handleAuraAIChat = async function(inputEl) {
            const userQuery = inputEl.value.trim();
            if (!userQuery) return;

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥ –∏ –∫–Ω–æ–ø–∫—É
            inputEl.value = '';
            inputEl.disabled = true;
            const sendBtn = document.getElementById('aura-ai-send-btn');
            if (sendBtn) sendBtn.disabled = true;

            // 1. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            displayMessage('user', userQuery);
            window.auraAIChatHistory.push({ role: 'user', parts: [{ text: userQuery }] });
            
            // 2. –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingHtml = `<div id="ai-loading" class="flex justify-start"><div class="bg-purple-600/80 rounded-xl rounded-tl-sm p-3 text-white max-w-xs shadow-md"><div class="animate-pulse">... –ü–µ—á–∞—Ç–∞–µ—Ç ...</div></div></div>`;
            const chatOutput = document.getElementById('aura-ai-chat-output');
            chatOutput.innerHTML += loadingHtml;
            chatOutput.scrollTop = chatOutput.scrollHeight;

            try {
                // 3. –í—ã–∑—ã–≤–∞–µ–º API
                const modelResponse = await fetchGeminiResponse(window.auraAIChatHistory);

                // 4. –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const loadingIndicator = document.getElementById('ai-loading');
                if (loadingIndicator) loadingIndicator.remove();

                // 5. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏
                displayMessage('model', modelResponse);
                window.auraAIChatHistory.push({ role: 'model', parts: [{ text: modelResponse }] });

            } catch (error) {
                // 4. –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                const loadingIndicator = document.getElementById('ai-loading');
                if (loadingIndicator) loadingIndicator.remove();
                displayMessage('model', `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}`);
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥
                inputEl.disabled = false;
                if (sendBtn) sendBtn.disabled = false;
                inputEl.focus();
            }
        }


        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        window.onload = function () {
            // –ü–ï–†–í–´–ú –î–ï–õ–û–ú: –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ç–µ–º–∞/–æ–±–æ–∏)
            applySettings();
            
            // 4. –õ–æ–≥–∏–∫–∞ –î–æ–∫–∞: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
            document.querySelectorAll('.dock-icon').forEach(icon => {
                icon.addEventListener('click', (e) => {
                    const appId = e.currentTarget.dataset.app;
                    let title;
                    let width = 600, height = 400;

                    switch(appId) {
                        case 'Finder': title = '–†–∞–±–æ—á–∏–π –°—Ç–æ–ª'; width = 800; height = 500; break;
                        case 'Browser': title = 'AuraBrowser'; break;
                        case 'Terminal': title = '–¢–µ—Ä–º–∏–Ω–∞–ª'; width = 700; height = 500; break;
                        case 'AuraAI': title = 'Aura AI Assistant'; width = 500; height = 700; break;
                        case 'Settings': title = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'; width = 500; height = 650; break;
                        default: title = '–ù–æ–≤–æ–µ –û–∫–Ω–æ';
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –æ–∫–Ω–æ, –∏ –µ—Å–ª–∏ –¥–∞, –ø—Ä–æ—Å—Ç–æ —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º –µ–≥–æ
                    const existingWindow = document.querySelector(`.window[data-app-id="${appId}"]`);
                    if (existingWindow) {
                         zIndexCounter++;
                         existingWindow.style.zIndex = zIndexCounter;
                         showMessage('AuraOS', `–û–∫–Ω–æ "${title}" —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ –∏ –±—ã–ª–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –Ω–∞ –ø–µ—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω.`);
                         return;
                    }

                    createWindow(appId, title, width, height);
                });
            });

            // –ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
            startLoadingScreen();
        };

    </script>
</body>
</html>